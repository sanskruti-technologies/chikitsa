CREATE OR REPLACE VIEW %dbprefix%view_bill AS select bill.bill_id AS bill_id,bill.bill_date AS bill_date,bill.visit_id AS visit_id,doctor.name AS doctor_name,ifnull(visit.doctor_id,bill.doctor_id) AS doctor_id,bill.clinic_id AS clinic_id,clinic.clinic_name AS clinic_name,patient.patient_id AS patient_id,patient.display_id AS display_id,contacts.first_name AS first_name,contacts.middle_name AS middle_name,contacts.last_name AS last_name,bill.total_amount AS total_amount,ifnull(bill.tax_amount,0) AS item_tax_amount,sum(bill_detail.amount) AS bill_tax_amount,bill.due_amount AS due_amount,(select sum(bill_payment_r.adjust_amount) from %dbprefix%bill_payment_r bill_payment_r where (bill_payment_r.bill_id = bill.bill_id)) AS pay_amount from %dbprefix%bill bill left join %dbprefix%visit visit on bill.visit_id = visit.visit_id left join %dbprefix%clinic clinic on clinic.clinic_id = bill.clinic_id left join %dbprefix%patient patient on bill.patient_id = patient.patient_id left join %dbprefix%contacts contacts on contacts.contact_id = patient.contact_id left join %dbprefix%view_doctor doctor on ifnull(visit.doctor_id,bill.doctor_id) = doctor.doctor_id left join %dbprefix%bill_detail bill_detail on bill_detail.bill_id = bill.bill_id and bill_detail.type = 'tax' group by bill.bill_id,doctor.name,visit.userid,patient.patient_id;
UPDATE %dbprefix%version SET current_version='0.7.2';