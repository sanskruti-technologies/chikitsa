ALTER TABLE %dbprefix%patient ADD clinic_code VARCHAR(6) NULL AFTER sync_status;
CREATE OR REPLACE VIEW %dbprefix%view_bill AS SELECT bill.bill_id AS bill_id,bill.bill_date AS bill_date,bill.visit_id AS visit_id,doctor.name AS doctor_name,visit.doctor_id AS doctor_id,bill.clinic_id AS clinic_id,clinic.clinic_name AS clinic_name,patient.patient_id AS patient_id,patient.display_id AS display_id,contacts.first_name AS first_name,contacts.middle_name AS middle_name,contacts.last_name AS last_name,bill.total_amount AS total_amount,bill.due_amount AS due_amount,SUM(bill_payment_r.adjust_amount) AS pay_amount FROM %dbprefix%bill AS bill JOIN %dbprefix%patient AS patient ON bill.patient_id = patient.patient_id JOIN %dbprefix%contacts AS contacts ON contacts.contact_id = patient.contact_id LEFT JOIN %dbprefix%visit AS visit ON bill.visit_id = visit.visit_id LEFT JOIN %dbprefix%clinic AS clinic ON clinic.clinic_id = bill.clinic_id LEFT JOIN %dbprefix%view_doctor AS doctor ON (visit.doctor_id = doctor.doctor_id) or (bill.doctor_id = doctor.doctor_id) LEFT JOIN %dbprefix%bill_payment_r AS bill_payment_r ON bill_payment_r.bill_id = bill.bill_id LEFT JOIN %dbprefix%payment AS payment ON payment.payment_id = bill_payment_r.payment_id GROUP BY bill.bill_id,doctor.name,visit.userid,patient.patient_id;
UPDATE %dbprefix%clinic SET time_interval = time_interval * 60;
ALTER TABLE %dbprefix%contacts CHANGE first_name first_name VARCHAR(50) CHARACTER SET utf8 COLLATE utf8_bin NULL DEFAULT NULL;
ALTER TABLE %dbprefix%contacts CHANGE middle_name middle_name VARCHAR(50) CHARACTER SET utf8 COLLATE utf8_bin NULL DEFAULT NULL;
ALTER TABLE %dbprefix%contacts CHANGE last_name last_name VARCHAR(50) CHARACTER SET utf8 COLLATE utf8_bin NULL DEFAULT NULL;
ALTER TABLE %dbprefix%contacts ADD area VARCHAR(25) NOT NULL AFTER  address_line_2;
ALTER TABLE %dbprefix%appointments ADD clinic_code VARCHAR(6) NULL DEFAULT NULL;
ALTER TABLE %dbprefix%appointment_log ADD clinic_code VARCHAR(6) NULL AFTER sync_status;
CREATE OR REPLACE VIEW %dbprefix%view_patient AS SELECT patient.patient_id,patient.clinic_id,patient.clinic_code,patient.patient_since, patient.age,patient.display_id,patient.gender,patient.dob, patient.reference_by, patient.followup_date,(SELECT IFNULL(SUM(IFNULL(patient_account.adjust_amount,0)),0) FROM %dbprefix%patient_account AS patient_account WHERE patient_account.patient_id = patient.patient_id AND payment_id IS NOT NULL) - (SELECT IFNULL(SUM(IFNULL(patient_account.adjust_amount,0)),0) FROM %dbprefix%patient_account AS patient_account WHERE patient_account.patient_id = patient.patient_id AND bill_id IS NOT NULL) AS in_account_amount,contacts.display_name,contacts.contact_id,contacts.first_name,contacts.middle_name,contacts.last_name,(SELECT contact_details.detail FROM %dbprefix%contact_details as contact_details WHERE contact_details.contact_id = contacts.contact_id AND contact_details.type='mobile' LIMIT 1) AS phone_number,	   contacts.email   FROM %dbprefix%patient as patient        LEFT JOIN %dbprefix%contacts as contacts ON patient.contact_id = contacts.contact_id;
ALTER TABLE %dbprefix%payment ADD clinic_code VARCHAR(6) NULL AFTER sync_status;
CREATE OR REPLACE VIEW %dbprefix%view_bill_payment_r AS SELECT payment.pay_date,       bill_payment_r.bill_id,	   bill_payment_r.adjust_amount,	   payment.payment_id  FROM %dbprefix%payment AS payment       JOIN %dbprefix%bill_payment_r AS bill_payment_r ON bill_payment_r.payment_id = payment.payment_id;	   
CREATE OR REPLACE VIEW %dbprefix%view_bill_detail_report  AS  SELECT bill.bill_id AS bill_id,bill.bill_date AS bill_date,bill.visit_id AS visit_id,bill_detail.particular AS particular,bill_detail.amount AS amount,visit.userid AS userid,concat(view_patient.first_name,' ',view_patient.middle_name,' ',view_patient.last_name) AS patient_name,view_patient.display_id AS display_id,bill_detail.type AS type from %dbprefix%bill bill left join %dbprefix%bill_detail bill_detail on bill_detail.bill_id = bill.bill_id left join %dbprefix%visit visit on visit.visit_id = bill.visit_id left join %dbprefix%view_patient view_patient on view_patient.patient_id = bill.patient_id where ifnull(bill_detail.is_deleted,0) <> 1 ;
ALTER TABLE %dbprefix%contacts ADD clinic_code VARCHAR(6) NULL AFTER sync_status;
ALTER TABLE %dbprefix%bill ADD clinic_code VARCHAR(6) NULL AFTER sync_status;
ALTER TABLE %dbprefix%contact_details ADD clinic_code VARCHAR(6) NULL AFTER sync_status;
ALTER TABLE %dbprefix%bill_detail ADD clinic_code VARCHAR(6) NULL AFTER sync_status;
ALTER TABLE %dbprefix%clinic ADD website VARCHAR(50) NULL AFTER sync_status;
ALTER TABLE %dbprefix%bill_payment_r ADD clinic_code VARCHAR(6) NULL AFTER sync_status;
CREATE OR REPLACE VIEW %dbprefix%view_bill AS SELECT bill.bill_id AS bill_id,               bill.bill_date AS bill_date,			   bill.visit_id AS visit_id,			   doctor.name AS doctor_name,			   visit.doctor_id AS doctor_id,			   visit.clinic_id,			   clinic.clinic_name,			   patient.patient_id AS patient_id,			   patient.display_id AS display_id,			   contacts.first_name AS first_name,			   contacts.middle_name AS middle_name,			   contacts.last_name AS last_name,			   bill.total_amount AS total_amount,			   bill.due_amount AS due_amount,			   SUM(bill_payment_r.adjust_amount) AS pay_amount         		  FROM %dbprefix%bill AS bill   		  join %dbprefix%visit AS visit ON bill.visit_id = visit.visit_id   		  LEFT OUTER join %dbprefix%clinic AS clinic on clinic.clinic_id = bill.clinic_id   		  join %dbprefix%patient AS patient on bill.patient_id = patient.patient_id   		  join %dbprefix%contacts AS contacts on contacts.contact_id = patient.contact_id   		  join %dbprefix%view_doctor As doctor on visit.doctor_id = doctor.doctor_id   		  LEFT OUTER JOIN %dbprefix%bill_payment_r AS bill_payment_r ON bill_payment_r.bill_id = bill.bill_id	   				  GROUP BY bill.bill_id,doctor.name,visit.userid, patient.patient_id;
UPDATE %dbprefix%version SET current_version='0.6.4';