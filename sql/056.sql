ALTER TABLE %dbprefix%appointments ADD doctor_id INT(11) NULL AFTER userid;
UPDATE %dbprefix%appointments AS appointments SET appointments.doctor_id = (SELECT doctor.doctor_id FROM %dbprefix%doctor AS doctor WHERE doctor.userid = appointments.userid);
ALTER TABLE %dbprefix%visit ADD doctor_id INT(11) NULL AFTER userid;
UPDATE %dbprefix%visit AS visit SET visit.doctor_id = (SELECT doctor.doctor_id FROM %dbprefix%doctor AS doctor WHERE doctor.userid = visit.userid);
CREATE OR REPLACE VIEW %dbprefix%view_doctor AS SELECT CONCAT(IFNULL(contacts.first_name,''),' ',IFNULL(contacts.middle_name,''),' ',IFNULL(contacts.last_name,'')) AS name, doctor.doctor_id,doctor.userid FROM %dbprefix%doctor AS doctor INNER JOIN %dbprefix%contacts As contacts ON contacts.contact_id = doctor.contact_id;
ALTER TABLE %dbprefix%followup ADD doctor_id INT(11) NULL AFTER userid;
UPDATE %dbprefix%followup AS followup SET followup.doctor_id = (SELECT doctor.doctor_id FROM %dbprefix%doctor AS doctor WHERE doctor.userid = followup.userid);
ALTER TABLE %dbprefix%contact_details ADD is_default INT(1) NULL AFTER detail;
CREATE OR REPLACE VIEW %dbprefix%view_report AS SELECT appointment.appointment_id, 		appointment.patient_id, 		CONCAT(IFNULL(view_patient.first_name,''),' ',IFNULL(view_patient.middle_name,''), ' ',IFNULL(view_patient.last_name,'')) as patient_name, 		appointment.doctor_id,		CONCAT(IFNULL(contacts.first_name,''),' ',IFNULL(contacts.middle_name,''), ' ',IFNULL(contacts.last_name,'')) as doctor_name, 		appointment.appointment_date, 		min(appointment.start_time) as appointment_time, 		max(CASE appointment_log.status WHEN 'Waiting' THEN appointment_log.from_time END) as waiting_in, 		(max(CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END) - max(CASE appointment_log.status WHEN 'Waiting' THEN appointment_log.from_time END)) as waiting_duration, 		max(CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END) as consultation_in, 		max(CASE appointment_log.status WHEN 'Complete' THEN appointment_log.from_time END) as consultation_out, 		(max(CASE appointment_log.status WHEN 'Complete' THEN appointment_log.from_time END) - max(CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END)) as consultation_duration, 		max(CASE appointment_log.old_status WHEN 'Consultation' THEN timediff(appointment_log.to_time,appointment_log.from_time) END) as waiting_out, max(bill.total_amount) as collection_amount 	FROM  %dbprefix%appointments as appointment               LEFT JOIN %dbprefix%view_patient as view_patient ON appointment.patient_id = view_patient.patient_id 	   			  LEFT JOIN %dbprefix%bill as bill ON appointment.visit_id = bill.visit_id 	   			  LEFT JOIN %dbprefix%appointment_log as appointment_log ON appointment.appointment_id = appointment_log.appointment_id	   			  LEFT JOIN %dbprefix%doctor AS doctor ON doctor.doctor_id = appointment.doctor_id   	  LEFT JOIN %dbprefix%contacts AS contacts ON contacts.contact_id = doctor.contact_id   	  GROUP BY appointment.appointment_id,patient_name;
CREATE OR REPLACE VIEW %dbprefix%view_patient AS SELECT patient.patient_id,      patient.patient_since,    patient.display_id,	   patient.gender,	   patient.dob, 	   patient.reference_by, 	   patient.followup_date,	   contacts.display_name,	   contacts.contact_id,	   contacts.first_name,	   contacts.middle_name,	   contacts.last_name,	   (SELECT contact_details.detail FROM %dbprefix%contact_details as contact_details WHERE contact_details.contact_id = contacts.contact_id AND contact_details.type='mobile' LIMIT 1) AS phone_number,	   contacts.email   FROM %dbprefix%patient as patient        LEFT JOIN %dbprefix%contacts as contacts ON patient.contact_id = contacts.contact_id;
ALTER TABLE %dbprefix%data CHANGE ck_value ck_value VARCHAR(1000) NULL DEFAULT NULL;
DELETE FROM %dbprefix%data WHERE ck_key = 'support_url' AND ck_value LIKE '<h4>Chikitsa would not have been possible%';
INSERT INTO %dbprefix%data (ck_key, ck_value) VALUES ( 'about_us_content', '<h4>Chikitsa would not have been possible without the amazing works listed below</h4><h5><b>Framework</b></h5><a href="http://codeigniter.com">CodeIgniter 3.0.0</a><h5><b></b></h5><a href="https://bitbucket.org/wiredesignz/codeigniter-modular-extensions-hmvc">Modular Extensions - HMVC<h5><b></b></h5></a><h5><b>Theme</b></h5><a href="http://www.bootstrapzero.com/bootstrap-template/binary">Binary Admin (Bootstrap v3.1.1)</a><h5><b></b></h5><a href="https://fortawesome.github.io/Font-Awesome/">Font Awsome </a><h5><b></b></h5><a href="https://plugins.jquery.com/chosen/">Chosen</a><br><a href="http://lokeshdhakar.com/projects/lightbox2/">Lightbox </a><br><a href="http://xdsoft.net/jqplugins/datetimepicker/">DateTime Picker </a><br><a href="http://intridea.github.io/sketch.js/">Sketch</a><br><a href="https://www.tinymce.com/">TinyMCE</a><br>');
CREATE OR REPLACE VIEW %dbprefix%view_bill AS SELECT bill.bill_id AS bill_id,        bill.bill_date AS bill_date,		bill.visit_id AS visit_id,		view_doctor.name AS doctor_name,		visit.doctor_id AS doctor_id,		patient.patient_id AS patient_id,		patient.display_id AS display_id,		contacts.first_name AS first_name,		contacts.middle_name AS middle_name,		contacts.last_name AS last_name,		bill.total_amount AS total_amount,		bill.due_amount AS due_amount,		SUM(bill_payment_r.adjust_amount) AS pay_amount  FROM %dbprefix%bill AS bill        join %dbprefix%visit AS visit ON bill.visit_id = visit.visit_id  	   join %dbprefix%view_doctor As view_doctor on visit.doctor_id = view_doctor.doctor_id 	   	   join %dbprefix%patient AS patient on bill.patient_id = patient.patient_id 	   	   INNER JOIN %dbprefix%bill_payment_r AS bill_payment_r ON bill_payment_r.bill_id = bill.bill_id	   	   join %dbprefix%payment AS payment on payment.payment_id = bill_payment_r.payment_id 	   	   join %dbprefix%contacts AS contacts on contacts.contact_id = patient.contact_id GROUP BY bill.bill_id,view_doctor.name,visit.userid, patient.patient_id;
UPDATE %dbprefix%version SET current_version='0.5.6';